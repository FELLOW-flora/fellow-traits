---
title: "Exploration of FELLOW trait dataset"
execute:
  echo: false
format: pdf
---


The objective of this document is to:  

- visually explore the trait database
- understand trait coverage / data gaps
- check for possible inconsistencies  


```{r load}
#| warning: false
#| echo: false
devtools::load_all()

# Load species list with taxonomy
traits <- read.csv(
  here::here("data", "tropical-data", "merged_traits.csv")
)

# Load species list with taxonomy
taxolist <- read.csv(
  here::here("data", "tropical-data", "species_list_taxo.csv")
)
# taxolist$original_taxa[is.na(taxolist$accepted_taxa)]
# remove NAs
taxolist <- taxolist[!is.na(taxolist$accepted_taxa), ]

# Load short species list
shortlist <- read.csv(
  here::here("data", "tropical-data", "species_short_list.csv")
)
```


## Description of the species list

We compiled the species lists from `{r} sum(grepl("^in_", names(taxolist)))`  datasets. 
After cleaning and harmonization, there were `{r} nrow(shortlist)` unique taxa.

```{r}
table(shortlist$accepted_rank)
```


{{< pagebreak >}}

## Description of trait databases

```{r}
real_traits <- !grepl("original", names(traits)) &
  names(traits) != "accepted_taxa"

# summary of NAs
num_na <- apply(!is.na(traits), 2, sum)

db_na <- num_na[grep("original", names(num_na))]
names(db_na) <- gsub("original_taxa_", "", names(db_na))

trait_na <- apply(!is.na(traits[, real_traits]), 2, sum)

# species with lowest completness
sp_na <- apply(!is.na(traits[, real_traits]), 1, sum)
```


So far, we compiled `{r} sum(real_traits)` traits for `{r} nrow(traits)` taxa gathered from `{r} length(db_na)` trait databases. But there are many missing values.

```{r nabase}
# database with best match
par(mar = c(4, 8, 1, 1), cex = 0.9)
barplot(
  sort(db_na),
  horiz = TRUE,
  las = 1,
  xlab = "Number of species with records in the database"
)
```



```{r natraits}
# summary of NAs
trait_db <- strsplit(names(trait_na), "_") |>
  sapply(function(x) x[[length(x)]]) |>
  factor(
    levels = names(db_na)[order(db_na)],
    ordered = TRUE
  )
# database with best match
par(mar = c(4, 8, 1, 1), cex = 0.9)
boxplot(
  trait_na ~ trait_db,
  horizontal = TRUE,
  las = 1,
  xlab = "Number of traits values",
  ylab = ""
)
```



```{r naspecies}
#| fig-height: 4
# hist(sp_na, xlab = "Number of missing traits", ylab = "Number of species")

# barplot(t(table(sp_na, taxolist$gbif_rank)), border = NA)
df <- data.frame(
  "cat" = cut(sp_na, breaks = seq(0, 100, by = 10), include.lowest = TRUE),
  "rank" = shortlist$accepted_rank
)
tdf <- table(df$rank, df$cat)
par(mar = c(4, 4, 1, 1))
barx <- barplot(
  tdf,
  col = hcl.colors(nrow(tdf), "viridis"),
  names = rep("", ncol(tdf)),
  xlab = "Number of traits",
  ylab = "Number of species"
)
barax <- c(barx - mean(diff(barx) / 2), max(barx) + mean(diff(barx) / 2))
axis(1, at = barax, seq(0, 100, by = 10))
legend(
  "topright",
  legend = firstup(row.names(tdf)),
  fill = hcl.colors(5, "viridis")
)
```



{{< pagebreak >}}

**Summary of trait completness**  
```{r traitcat}
trname <- names(traits)[real_traits]

trone <- sapply(strsplit(trname, "_"), function(x) x[[1]])
trone <- gsub(".mm2.mg.1", "", trone) # SLA must be checked in metatraits
trone <- gsub("Fruit.colour", "Fruit.color", trone) # to be replaced in metatraits
trone[grepl("Flower.UV.reflectance", trone)] <- "Flower.UV.reflectance"

# calculate the completeness of each traits
trna <- apply(!is.na(traits[, real_traits]), 1, as.numeric)
summaryna <- apply(rowsum(trna, trone) > 0, 1, sum)
# to be removed: variables with no information
summaryna <- summaryna[summaryna > 0]

completness <- data.frame(
  "trait" = names(summaryna),
  "database" = as.numeric(table(trone[trone %in% names(summaryna)])),
  "N_taxa" = as.numeric(summaryna),
  "completness" = round(as.numeric(summaryna) / nrow(traits) * 100)
)

# DT::datatable(completness)
knitr::kable(
  completness[order(completness$N_taxa, decreasing = TRUE), ],
  row.names = FALSE,
  col.names = c("Trait", "N database", "N taxa", "Completness (%)")
)
```


{{< pagebreak >}}


Taxa with no trait information (N=`{r} sum(sp_na==0)`).
```{r nodata}
nodata <- traits$accepted_taxa[sp_na == 0]
print(nodata)
```


{{< pagebreak >}}

## Comparison

### SLA
There are four sources of information for Specific leaf area (SLA) : Hodgson et al. 2023 (in mm2/mg), GIFT (in cm2/g), BIEN (in m2/kg = mm2/mg), and Ladouceur et al. 2023 (in cm2/g).

```{r sla}
# names(traits)[grep("SLA", names(traits))]
sla <- data.frame(
  "Hodgson" = traits$SLA.mm2.mg.1_Hodgson2023,
  "GIFT" = traits$SLA_cm2.g.1_GIFT / 10,
  "BIEN" = traits$SLA_m2.kg.1_BIEN,
  "Ladouceur" = traits$SLA_cm2.g.1_Ladouceur2019 / 10
)

pairs(sla, lower.panel = panel.smooth, upper.panel = panel.cor)
```

Values are highly correlated, so we could imagine filling the missing values (using preferred data sources or averaging them).  

**Number of SLA values:**  
```{r fillsla}
sla$filled <- apply(sla, 1, mean, na.rm = TRUE)
# sla$filled <- ifelse(
#   is.na(sla$GIFT),
#   ifelse(is.na(sla$BIEN), sla$Hodgson, sla$BIEN),
#   sla$GIFT
# )

print(apply(!is.na(sla), 2, sum))
```


{{< pagebreak >}}


### Plant height
There are seven sources of information for plant height.

```{r height}
#| fig-height: 5

# names(traits)[grep("height", names(traits))]

height <- data.frame(
  "Ladouceur" = traits$Plant.height_cm_Ladouceur2019 / 100,
  "Lososova" = traits$Plant.height_m_Lososova2023,
  "BIEN" = traits$Plant.height_m_BIEN,
  "GIFT" = traits$Plant.height_mean_m_GIFT,
  "Ecoflora" = traits$Plant.height_m_Ecoflora
)

pairs(height, lower.panel = panel.smooth, upper.panel = panel.cor)
```


**Number of Plant height values:**  
```{r fillheight}
# height$average <- apply(height, 1, mean, na.rm = TRUE)
colfill <- sapply(apply(!is.na(height), 1, which), function(x) {
  ifelse(length(x) > 0, x[[1]], NA)
})
height$filled <- height[cbind(1:nrow(height), colfill)]
print(apply(!is.na(height), 2, sum))
```

{{< pagebreak >}}

### Seed mass
There are six sources of information for seed mass

```{r seed}
#| fig-height: 5
# names(traits)[grep("Seed", names(traits))]

seed <- data.frame(
  "Lososova" = traits$Seed.mass_mg_Lososova2023,
  "BIEN" = traits$Seed.mass_mg_BIEN,
  "GIFT" = traits$Seed.mass_g_GIFT * 1000,
  "Ecoflora" = traits$Seed.mass_mg_Ecoflora,
  "Biolflor" = traits$Seed.mass_mg_Biolflor,
  "Ladouceur" = traits$Seed.mass_g_Ladouceur2019
)

pairs(seed, lower.panel = panel.smooth, upper.panel = panel.cor, log = "xy") |>
  suppressWarnings()

```

**Number of Seed mass values:**  
```{r fillseed}
# sla$average <- apply(sla, 1, mean, na.rm = TRUE)
colfill <- sapply(apply(!is.na(seed), 1, which), function(x) {
  ifelse(length(x) > 0, x[[1]], NA)
})
seed$filled <- seed[cbind(1:nrow(seed), colfill)]

print(apply(!is.na(seed), 2, sum))
```

